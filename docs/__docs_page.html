<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:300,400,700" rel="stylesheet">
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
        />    
        <style>
            body {
                margin: 0;
                padding: 0;
            }

            .tio-label {
                font-family: Roboto, sans-serif;
                font-weight: bold;
                font-size: 14px;
                line-height: 1.5em;
                color: rgb(51, 51, 51);
                -webkit-font-smoothing: antialiased;
                text-size-adjust: 100%;
                text-rendering: optimizespeed !important;
                margin-right: 5px;
                padding: 0;
                margin-top: 0;
            }

            .choices__inner {
                font-family: Roboto, sans-serif;
                font-weight: 400;
                font-size: 14px;
                line-height: 1.0em;
                color: rgb(51, 51, 51);
                -webkit-font-smoothing: antialiased;
                text-size-adjust: 100%;
                text-rendering: optimizespeed !important;
                padding: 0 !important;
                margin: 0 !important;
                max-width: 300px !important;
            }

            .choices {
                display: inline;
            }

            .choice-div {
                margin-top: 10px;
                margin-bottom: 10px;
            }

            .choices__inner {
                min-height: 0 !important;
                padding: 0 !important;
            }

            .choices__list--dropdown {
                min-height: 0 !important;
                padding: 0 !important;
            }

            input, .choices__inner {
                border: 1px solid #ccc;
                border-radius: 4px;
                padding: 5px;
                width: 300px;
                height: 30px;
                background-color:white !important;
                opacity: 1 !important;
            }
        </style>
    </head>
    <redoc spec-url='/openapi.json'></redoc>
    <script src="https://cdn.jsdelivr.net/npm/redoc@2.0.0/bundles/redoc.standalone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/insertion-query@1.1.0/insQ.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>  
    <script>
        function docReady(fn) {
            // see if DOM is already available
            if (document.readyState === "complete" || document.readyState === "interactive") {
                // call on next available tick
                setTimeout(fn, 1);
            } else {
                document.addEventListener("DOMContentLoaded", fn);
            }
        }   

        let sunbeamUrl = "{%sunbeam%}"
        let clientId = "{%clientId%}"
        
        // LoginUser API
        function loginUser(el, state, callback) {
            if(!state) {
                throw new Error("State is required");
            }

            // Create a iframe to https://fateslist.xyz to get the user token
            let loginWindow = window.open(`https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${sunbeamUrl}/frostpaw/login&response_type=code&scope=identify&state=${state}`);
            
            window.loginCallback = callback
        }
        window.addEventListener("message", (evt) => {
            if(evt.origin != sunbeamUrl) return;
            evt.source.close()
            window.loginCallback(JSON.parse(atob(evt.data)))
        })

        // Data Action start
        function dataAction(el, mode) {
            if(window.dataActionSelected) {
                alert("You have already selected an action")
                return
            }
            loginUser(el, 'api-em', (user) => {
                console.log(user)
                let userIdInp = document.createElement("input")
                userIdInp.id = "userId-da"
                let userIdFor = document.createElement("label")
                userIdFor.htmlFor = "userId-da"

                userIdFor.innerText = "Enter User ID"
                userIdInp.value = user.user.id

                let actionDiv = document.createElement("div")
                actionDiv.appendChild(userIdFor)
                actionDiv.appendChild(userIdInp)
                el.parentElement.appendChild(actionDiv)
                el.parentElement.removeChild(el);

                window.dataActionSelected = mode

                let submitBtn = document.createElement("button")
                submitBtn.innerText = "Submit"
                submitBtn.onclick = () => {
                    let userId = document.getElementById("userId-da").value
                    fetch(`/data/${userId}?em_token=${user.token}&mode=${window.dataActionSelected}`).then(res => res.json()).then(res => {
                        if(res.error) {
                            alert(res.error)
                        } else {
                            alert("Success")
                        }
                    })
                }

                actionDiv.appendChild(submitBtn)
            })
        }

        String.prototype.toTitle = function() {
            return this.replaceAll("_", "").replace(/(^|\s)\S/g, function(t) { return t.toUpperCase() });
        };

        handled = new Map()

        class TryItOut {
            constructor(el) {
                this.el = el
                this.tidDat = JSON.parse(atob(el.getAttribute('data-tryitout')))

                console.log("TryItOut", el, this.tidDat)

                this.el.innerHTML = `
<h3>Try it out</h3>

<div id=${this.tidDat.name}-body></div>
                `

                if(Object.keys(this.tidDat.body).length > 0) {
                    console.warn("Got body: ", this.tidDat.body)
                    
                    document.querySelector(`#${this.tidDat.name}-body`).innerHTML = "<h3>Body</h3>"

                    this.addAtLevel(`${this.tidDat.name}-body`, this.tidDat.body);
                }
            }

            handleList(id, k, type) {
                let baseType = type.split(":")[1];
                let choiceEl = document.createElement("input");
                choiceEl.id = k;
                choiceEl.type = "text";

                let label = document.createElement("label");
                label.classList.add("tio-label")

                label.innerText = k.toTitle();

                let div = document.createElement("div");
                div.classList.add("choice-div");
                div.appendChild(label);
                div.appendChild(choiceEl);

                document.getElementById(id).appendChild(div);

                let choices = new Choices(choiceEl, {
                    allowHTML: true,
                    items: [],
                    choices: [],
                    delimiter: ',',
                    editItems: true,
                    removeItemButton: true,
                    renderSelectedChoices: 'auto',
                    paste: true,
                    searchEnabled: true,
                    searchChoices: true,
                    placeholder: true,
                    addItemText: (value) => {
                        return `Press Enter to add <b>"${value}"</b>`;
                    },
                    maxItemText: (maxItemCount) => {
                        return `Only ${maxItemCount} values can be added`;
                    },
                    valueComparer: (value1, value2) => {
                        return value1 === value2;
                    },
                    labelId: '',
                    callbackOnInit: null,
                    callbackOnCreateTemplates: null
                })
            }

            addAtLevel(id, level) {
                // Loop over body and add to body as inputs
                for(var key in level) {
                    if(key == "_nested") {
                        continue
                    }

                    if(level[key]._nested) {
                        console.log("Handling nested")
                        let h3 = document.createElement("h4");
                        h3.innerText = key.toTitle();
                        document.getElementById(id).appendChild(h3);
                        this.addAtLevel(id, level[key]);
                        continue;
                    }

                    console.log(key)

                    var val = level[key];

                    let el = document.createElement("div");
                    el.classList.add("input")

                    let label = document.createElement("label");
                    label.classList.add("tio-label")
                    label.innerText = key.toTitle();
                    label.htmlFor = id + "-" + "key";
                    el.appendChild(label);

                    console.log(val, level)

                    if(val.startsWith("list")) {
                        this.handleList(id, key, val)
                        continue
                    }

                    let input = document.createElement("input");
                    input.id = id + "-" + key;
                    input.name = key;
                    input.type = val;
                    input.innerText = key.toTitle();
                    input.placeholder = key.toTitle();
                    el.appendChild(input);

                    document.getElementById(id).appendChild(el);
                }
            }

        }

        function handleTryItOut(el) {
            if(el.id in handled) {
                return
            }

            console.log(el.id)

            handled.set(el.id, new TryItOut(el))
        }


        docReady(() => {
            document.querySelectorAll(".try-it-out").forEach(el => {
                handleTryItOut(el)
            });

            insertionQ('.try-it-out').every((el) => {
                handleTryItOut(el)
                //callback
            });
        });
    </script>
</html>